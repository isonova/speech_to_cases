name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Fast unit-test job that runs on the runner's Python (your existing job)
  python-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dev requirements
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests (fast)
        run: |
          pytest -q --maxfail=1

  # Build the Docker image and run the same tests inside the image.
  # This validates native system libraries (ffmpeg/libsndfile/webrtcvad) together with your code.
  docker-build-test:
    runs-on: ubuntu-latest
    needs: python-tests   # optional: run fast tests first
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t speech_cases:ci .

      - name: Run pytest inside Docker image
        # install pytest inside the container and run tests. This avoids changing the image permanently.
        run: |
          docker run --rm speech_cases:ci bash -lc "python -m pip install --no-cache-dir pytest && pytest -q tests/test_asr.py"
